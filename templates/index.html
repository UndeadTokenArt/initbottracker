<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initiative Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .player-card {
            transition: all 0.3s ease-in-out;
        }
       .turn-indicator {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-100 tracking-tight">Initiative Order</h1>
            <p id="status-text" class="text-gray-400 mt-2">Connecting to bot...</p>
        </header>

        <main id="initiative-list" class="space-y-3">
            <!-- Player cards will be dynamically inserted here -->
        </main>
        
        <div id="placeholder" class="hidden text-center py-16 px-6 bg-gray-800 rounded-lg mt-8">
             <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="mt-2 text-lg font-medium text-gray-200">Waiting for players</h3>
            <p class="mt-1 text-sm text-gray-400">Join a voice channel and use the <code class="bg-gray-700 text-indigo-300 px-1.5 py-0.5 rounded">/io</code> command in Discord.</p>
        </div>

    </div>

    <script>
        const listElement = document.getElementById('initiative-list');
        const statusTextElement = document.getElementById('status-text');
        const placeholderElement = document.getElementById('placeholder');
        
        // The URL where your Go bot is serving the JSON data.
        const apiUrl = 'http://localhost:8081/initiative';

        // Function to fetch and render the player data
async function fetchAndRender() {
    try {
        const response = await fetch(apiUrl, {
        });
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const players = await response.json();
        
        statusTextElement.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        renderPlayers(players);

    } catch (error) {
        console.error("Failed to fetch initiative data:", error);
        statusTextElement.textContent = 'Error: Could not connect to the bot.';
        listElement.innerHTML = ''; // Clear the list on error
        placeholderElement.classList.remove('hidden');
    }
}

        // Function to render the list of players
        function renderPlayers(players) {
            if (!players || players.length === 0) {
                listElement.innerHTML = '';
                placeholderElement.classList.remove('hidden');
                return;
            }

            placeholderElement.classList.add('hidden');
            
            // Use user IDs as keys to update existing elements smoothly
            const existingPlayerIds = new Set(Array.from(listElement.children).map(child => child.dataset.userId));
            const incomingPlayerIds = new Set(players.map(p => p.userID));

            // Remove players who are no longer in the list
            existingPlayerIds.forEach(id => {
                if (!incomingPlayerIds.has(id)) {
                    const el = listElement.querySelector(`[data-user-id="${id}"]`);
                    if (el) el.remove();
                }
            });

            // Add or update players
            players.forEach((player, index) => {
                let card = listElement.querySelector(`[data-user-id="${player.userID}"]`);
                
                const isFirst = index === 0;

                if (!card) {
                    card = document.createElement('div');
                    card.dataset.userId = player.userID;
                    card.className = 'player-card flex items-center p-4 bg-gray-800 rounded-lg shadow-md border border-transparent';
                    card.innerHTML = `
                        <div class="relative mr-4">
                            <img class="w-16 h-16 rounded-full" src="" alt="Player Avatar">
                            <div class="turn-indicator absolute -top-1 -right-1 h-5 w-5 bg-green-400 rounded-full border-2 border-gray-800 flex items-center justify-center opacity-0">
                                <svg class="w-3 h-3 text-green-900" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <p class="text-xl font-semibold text-gray-100"></p>
                            <p class="text-sm text-gray-400">Initiative: <span class="font-bold text-lg text-indigo-400"></span></p>
                        </div>
                    `;
                    listElement.appendChild(card);
                }

                // Update content
                card.querySelector('img').src = player.avatarURL || 'https://placehold.co/128x128/7f8ea3/EBF4FF?text=?';
                card.querySelector('.text-xl').textContent = player.username;
                card.querySelector('.text-indigo-400').textContent = player.initiative;
                
                // Update styles for turn indicator
                card.querySelector('.turn-indicator').style.opacity = isFirst ? '1' : '0';
                card.style.borderColor = isFirst ? 'rgba(52, 211, 153, 0.7)' : 'transparent';
                card.style.transform = isFirst ? 'scale(1.02)' : 'scale(1)';

                // Reorder element in the DOM
                if (listElement.children[index] !== card) {
                    listElement.insertBefore(card, listElement.children[index]);
                }
            });
        }

        // Fetch data initially and then every 3 seconds
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRender();
            setInterval(fetchAndRender, 3000);
        });
    </script>
</body>
</html>
